<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Dylan Sutro Quartet - Dylan Sutro</title>
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <meta content="Dylan Sutro Quartet, Modern Jazz, Dylan Sutro, Santa Cruz, San Francisco" name="keywords">
  <meta content="Dylan Sutro Quartet - Modern Jazz blending favorite elements of jazz with other styles" name="description">

  <!-- Favicons -->
  <link href="../../img/favicon.png" rel="icon">
  <link href="../../img/apple-touch-icon.png" rel="apple-touch-icon">

  <!-- Bootstrap CSS File -->
  <link href="../../lib/bootstrap/css/bootstrap.min.css" rel="stylesheet">

  <!-- Libraries CSS Files -->
  <link href="../../lib/font-awesome/css/font-awesome.min.css" rel="stylesheet">
  <link href="../../lib/animate/animate.min.css" rel="stylesheet">
  <link href="../../lib/ionicons/css/ionicons.min.css" rel="stylesheet">
  <link href="../../lib/owlcarousel/assets/owl.carousel.min.css" rel="stylesheet">
  <link href="../../lib/lightbox/css/lightbox.min.css" rel="stylesheet">

  <!-- Main Stylesheet File -->
  <link href="../../css/style.css" rel="stylesheet">
  
  <style>
    .waveform-container {
      margin-bottom: 2rem;
      padding: 1.5rem;
      background-color: #f8f9fa;
      border-radius: 8px;
    }
    .waveform-title {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 1rem;
      text-transform: capitalize;
    }
    .waveform-wrapper {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin: 1rem 0;
    }
    .waveform-play-button {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background-color: #0078ff;
      color: white;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: background-color 0.3s ease;
      font-size: 1.2rem;
    }
    .waveform-play-button:hover {
      background-color: #0056b3;
    }
    .waveform-play-button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    .waveform-play-button .play-icon {
      display: inline-block;
    }
    .waveform-play-button .pause-icon {
      display: none;
    }
    .waveform-play-button.playing .play-icon {
      display: none;
    }
    .waveform-play-button.playing .pause-icon {
      display: inline-block;
    }
    .waveform-canvas {
      flex: 1;
      height: 128px;
      background-color: #fff;
      border-radius: 4px;
      cursor: pointer;
    }
    .waveform-controls {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-top: 1rem;
    }
  </style>
</head>

<body id="page-top">

  <!--/ Nav Star /-->
  <nav class="navbar navbar-b navbar-trans navbar-expand-md fixed-top" id="mainNav">
    <div class="container">
      <a class="navbar-brand js-scroll" href="../../index.html">Dylan Sutro</a>
      <button class="navbar-toggler collapsed" type="button" data-toggle="collapse" data-target="#navbarDefault"
        aria-controls="navbarDefault" aria-expanded="false" aria-label="Toggle navigation">
        <span></span>
        <span></span>
        <span></span>
      </button>
      <div class="navbar-collapse collapse justify-content-end" id="navbarDefault">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" href="../../index.html">Home</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="../../engineering.html">Engineering</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="../../music.html">Music</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="../../about.html">About</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="../../contact.html">Contact</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  <!--/ Nav End /-->

  <!--/ Intro Skew Star /-->
  <div id="home" class="intro route bg-image" style="background-image: url(../../assets/music/pics/DSQ_downtown.jpeg)">
    <div class="overlay-itro"></div>
    <div class="intro-content display-table">
      <div class="table-cell">
        <div class="container">
          <h1 class="intro-title mb-4">Dylan Sutro Quartet</h1>
          <p class="intro-subtitle"><span class="text-slider-items">Modern Jazz,Santa Cruz,San Francisco,Active Booking</span><strong class="text-slider"></strong></p>
        </div>
      </div>
    </div>
  </div>
  <!--/ Intro Skew End /-->

  <!--/ Section About Star /-->
  <section id="about" class="about-mf sect-pt4 route">
    <div class="container">
      <div class="row">
        <div class="col-sm-12">
          <div class="box-shadow-full">
            <div class="row">
              <div class="col-md-12">
                <div class="about-me pt-4 pt-md-0">
                  <div class="title-box-2">
                    <h5 class="title-left">
                      About
                    </h5>
                  </div>
                  <p class="lead">
                    The Dylan Sutro Quartet plays Modern Jazz focused on blending our favorite elements of jazz with other styles. 
                    We are actively booking and playing shows in the Santa Cruz and San Francisco Area.
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
  <!--/ Section About End /-->

  <!--/ Section Band Members Star /-->
  <section id="members" class="services-mf route">
    <div class="container">
      <div class="row">
        <div class="col-sm-12">
          <div class="title-box text-center">
            <h3 class="title-a">
              Band Members
            </h3>
            <p class="subtitle-a">
              Meet the musicians
            </p>
            <div class="line-mf"></div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-3 mb-4">
          <div class="service-box">
            <div class="service-ico">
              <span class="ico-circle"><i class="ion-music-note"></i></span>
            </div>
            <div class="service-content">
              <h2 class="s-title">Dylan Sutro</h2>
              <p class="s-description text-center">
                Guitar
              </p>
              <div class="text-center mt-3">
                <img src="../../assets/music/pics/headshot_with_guitar.jpeg" alt="Dylan Sutro" class="img-fluid rounded" style="max-height: 200px; object-fit: cover;">
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-3 mb-4">
          <div class="service-box">
            <div class="service-ico">
              <span class="ico-circle"><i class="ion-music-note"></i></span>
            </div>
            <div class="service-content">
              <h2 class="s-title">Max Goldfield</h2>
              <p class="s-description text-center">
                Saxophone
              </p>
              <div class="text-center mt-3">
                <img src="../../assets/music/pics/DSQ_Max.jpeg" alt="Max Goldfield" class="img-fluid rounded" style="max-height: 200px; object-fit: cover;">
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-3 mb-4">
          <div class="service-box">
            <div class="service-ico">
              <span class="ico-circle"><i class="ion-music-note"></i></span>
            </div>
            <div class="service-content">
              <h2 class="s-title">Micah Lyons</h2>
              <p class="s-description text-center">
                Upright & Electric Bass
              </p>
              <div class="text-center mt-3">
                <img src="../../assets/music/pics/DSQ_Micah.jpeg" alt="Micah Lyons" class="img-fluid rounded" style="max-height: 200px; object-fit: cover;">
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-3 mb-4">
          <div class="service-box">
            <div class="service-ico">
              <span class="ico-circle"><i class="ion-music-note"></i></span>
            </div>
            <div class="service-content">
              <h2 class="s-title">Will Davies</h2>
              <p class="s-description text-center">
                Drums & Cymbals
              </p>
              <div class="text-center mt-3">
                <img src="../../assets/music/pics/DSQ_Will.jpeg" alt="Will Davies" class="img-fluid rounded" style="max-height: 200px; object-fit: cover;">
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
  <!--/ Section Band Members End /-->

  <!--/ Section Discography Star /-->
  <section id="discography" class="portfolio-mf sect-pt4 route">
    <div class="container">
      <div class="row">
        <div class="col-sm-12">
          <div class="title-box text-center">
            <h3 class="title-a">
              Discography
            </h3>
            <p class="subtitle-a">
              Recordings and releases
            </p>
            <div class="line-mf"></div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-12">
          <div class="box-shadow-full">
            <div class="row mt-4">
              <div class="col-md-6 mb-4">
                <div class="waveform-container">
                  <div class="waveform-title">Carrot Cake</div>
                  <div class="waveform-wrapper">
                    <button id="play-pause-carrot_cake" class="waveform-play-button">
                      <i class="fa fa-play play-icon"></i>
                      <i class="fa fa-pause pause-icon"></i>
                    </button>
                    <canvas id="waveform-carrot_cake" class="waveform-canvas"></canvas>
                  </div>
                  <audio id="audio-carrot_cake" preload="auto">
                    <source src="../../assets/music/audio/carrot_cake.wav" type="audio/wav">
                  </audio>
                  <div class="waveform-controls">
                    <span id="time-carrot_cake">0:00 / 0:00</span>
                  </div>
                </div>
              </div>
              <div class="col-md-6 mb-4">
                <div class="waveform-container">
                  <div class="waveform-title">Days of Wine and Roses</div>
                  <div class="waveform-wrapper">
                    <button id="play-pause-days_of_wine_and_roses" class="waveform-play-button">
                      <i class="fa fa-play play-icon"></i>
                      <i class="fa fa-pause pause-icon"></i>
                    </button>
                    <canvas id="waveform-days_of_wine_and_roses" class="waveform-canvas"></canvas>
                  </div>
                  <audio id="audio-days_of_wine_and_roses" preload="auto">
                    <source src="../../assets/music/audio/days_of_wine_and_roses.wav" type="audio/wav">
                  </audio>
                  <div class="waveform-controls">
                    <span id="time-days_of_wine_and_roses">0:00 / 0:00</span>
                  </div>
                </div>
              </div>
              <div class="col-md-6 mb-4">
                <div class="waveform-container">
                  <div class="waveform-title">Fee Fi Fo Fum</div>
                  <div class="waveform-wrapper">
                    <button id="play-pause-fee_fi_fo_fum" class="waveform-play-button">
                      <i class="fa fa-play play-icon"></i>
                      <i class="fa fa-pause pause-icon"></i>
                    </button>
                    <canvas id="waveform-fee_fi_fo_fum" class="waveform-canvas"></canvas>
                  </div>
                  <audio id="audio-fee_fi_fo_fum" preload="auto">
                    <source src="../../assets/music/audio/fee_fi_fo_fum.wav" type="audio/wav">
                  </audio>
                  <div class="waveform-controls">
                    <span id="time-fee_fi_fo_fum">0:00 / 0:00</span>
                  </div>
                </div>
              </div>
              <div class="col-md-6 mb-4">
                <div class="waveform-container">
                  <div class="waveform-title">Liam's House</div>
                  <div class="waveform-wrapper">
                    <button id="play-pause-liams_house" class="waveform-play-button">
                      <i class="fa fa-play play-icon"></i>
                      <i class="fa fa-pause pause-icon"></i>
                    </button>
                    <canvas id="waveform-liams_house" class="waveform-canvas"></canvas>
                  </div>
                  <audio id="audio-liams_house" preload="auto">
                    <source src="../../assets/music/audio/liams_house.wav" type="audio/wav">
                  </audio>
                  <div class="waveform-controls">
                    <span id="time-liams_house">0:00 / 0:00</span>
                  </div>
                </div>
              </div>
              <div class="col-md-6 mb-4">
                <div class="waveform-container">
                  <div class="waveform-title">Ode to Omar</div>
                  <div class="waveform-wrapper">
                    <button id="play-pause-ode_to_omar" class="waveform-play-button">
                      <i class="fa fa-play play-icon"></i>
                      <i class="fa fa-pause pause-icon"></i>
                    </button>
                    <canvas id="waveform-ode_to_omar" class="waveform-canvas"></canvas>
                  </div>
                  <audio id="audio-ode_to_omar" preload="auto">
                    <source src="../../assets/music/audio/ode_to_omar.wav" type="audio/wav">
                  </audio>
                  <div class="waveform-controls">
                    <span id="time-ode_to_omar">0:00 / 0:00</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
  <!--/ Section Discography End /-->

  <!--/ Section Videos Star /-->
  <section id="videos" class="portfolio-mf sect-pt4 route">
    <div class="container">
      <div class="row">
        <div class="col-sm-12">
          <div class="title-box text-center">
            <h3 class="title-a">
              Videos
            </h3>
            <p class="subtitle-a">
              Performance videos and musical content
            </p>
            <div class="line-mf"></div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-12">
          <div class="box-shadow-full">
            <p class="lead text-center">
              Performance videos and musical content coming soon. This section will feature live performances, 
              music videos, and behind-the-scenes content.
            </p>
            <!-- Placeholder for video content -->
            <div class="row mt-4">
              <div class="col-md-6">
                <div class="work-box">
                  <div class="work-img">
                    <img src="../../assets/music/pics/IMG_5829.jpeg" alt="Music Performance" class="img-fluid" style="width: 100%; height: 300px; object-fit: cover;">
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="work-box">
                  <div class="work-img">
                    <img src="../../assets/music/pics/IMG_5849.jpeg" alt="Music Performance" class="img-fluid" style="width: 100%; height: 300px; object-fit: cover;">
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
  <!--/ Section Videos End /-->

  <!--/ Section Media Star /-->
  <section id="media" class="portfolio-mf sect-pt4 route">
    <div class="container">
      <div class="row">
        <div class="col-sm-12">
          <div class="title-box text-center">
            <h3 class="title-a">
              Media
            </h3>
            <p class="subtitle-a">
              Posters, videos, and recordings
            </p>
            <div class="line-mf"></div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-12">
          <div class="box-shadow-full">
            <div class="row mt-4">
              <div class="col-md-6 mb-4">
                <h5 class="title-left">Show Poster</h5>
                <p class="lead">Poster image coming soon.</p>
                <!-- Placeholder for poster image - will be added when provided -->
              </div>
              <div class="col-md-6 mb-4">
                <h5 class="title-left">Animated Poster</h5>
                <div class="text-center">
                  <video autoplay loop muted playsinline class="img-fluid" style="width: 100%; max-width: 600px;">
                    <source src="../../assets/music/vids/DSQ_shanty_shack_animated.mp4" type="video/mp4">
                    Your browser does not support the video tag.
                  </video>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
  <!--/ Section Media End /-->

  <!--/ Section Performances Star /-->
  <section id="performances" class="services-mf route">
    <div class="container">
      <div class="row">
        <div class="col-sm-12">
          <div class="title-box text-center">
            <h3 class="title-a">
              Performances
            </h3>
            <p class="subtitle-a">
              Live shows and musical events
            </p>
            <div class="line-mf"></div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-12">
          <div class="box-shadow-full">
            <p class="lead text-center">
              Upcoming and past performances will be listed here. Check back for show dates and venues.
            </p>
          </div>
        </div>
      </div>
    </div>
  </section>
  <!--/ Section Performances End /-->

  <!--/ Section Contact-Footer Star /-->
  <section class="paralax-mf footer-paralax bg-image sect-mt4 route" style="background-image: url(../../img/overlay-bg.jpg)">
    <div class="overlay-mf"></div>
    <footer>
      <div class="container">
        <div class="row">
          <div class="col-sm-12">
            <div class="copyright-box">
              <p class="copyright">&copy; Copyright <strong>Dylan Sutro</strong>. All Rights Reserved</p>
              <div class="credits">
                <a href="../../music.html">‚Üê Back to Music</a> | Template by <a href="https://bootstrapmade.com/">BootstrapMade</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </footer>
  </section>
  <!--/ Section Contact-footer End /-->

  <a href="#" class="back-to-top"><i class="fa fa-chevron-up"></i></a>
  <div id="preloader"></div>

  <!-- JavaScript Libraries -->
  <script src="../../lib/jquery/jquery.min.js"></script>
  <script src="../../lib/jquery/jquery-migrate.min.js"></script>
  <script src="../../lib/popper/popper.min.js"></script>
  <script src="../../lib/bootstrap/js/bootstrap.min.js"></script>
  <script src="../../lib/easing/easing.min.js"></script>
  <script src="../../lib/counterup/jquery.waypoints.min.js"></script>
  <script src="../../lib/counterup/jquery.counterup.js"></script>
  <script src="../../lib/owlcarousel/owl.carousel.min.js"></script>
  <script src="../../lib/lightbox/js/lightbox.min.js"></script>
  <script src="../../lib/typed/typed.min.js"></script>

  <!-- Template Main Javascript File -->
  <script src="../../js/main.js"></script>

  <!-- Custom Waveform Audio Players using Web Audio API -->
  <script>
    // Audio files configuration
    const audioFiles = [
      { id: 'carrot_cake', title: 'Carrot Cake', file: '../../assets/music/audio/carrot_cake.wav' },
      { id: 'days_of_wine_and_roses', title: 'Days of Wine and Roses', file: '../../assets/music/audio/days_of_wine_and_roses.wav' },
      { id: 'fee_fi_fo_fum', title: 'Fee Fi Fo Fum', file: '../../assets/music/audio/fee_fi_fo_fum.wav' },
      { id: 'liams_house', title: "Liam's House", file: '../../assets/music/audio/liams_house.wav' },
      { id: 'ode_to_omar', title: 'Ode to Omar', file: '../../assets/music/audio/ode_to_omar.wav' }
    ];

    // Store audio players
    const audioPlayers = {};

    // Initialize each audio player
    audioFiles.forEach(track => {
      const audio = document.getElementById(`audio-${track.id}`);
      const canvas = document.getElementById(`waveform-${track.id}`);
      const playPauseBtn = document.getElementById(`play-pause-${track.id}`);
      const timeDisplay = document.getElementById(`time-${track.id}`);

      if (!audio || !canvas || !playPauseBtn || !timeDisplay) {
        console.error('Missing elements for track:', track.id);
        return;
      }

      // Set canvas size properly
      const setCanvasSize = () => {
        const dpr = window.devicePixelRatio || 1;
        const rect = canvas.getBoundingClientRect();
        canvas.width = rect.width * dpr;
        canvas.height = 128 * dpr;
        canvas.style.width = rect.width + 'px';
        canvas.style.height = '128px';
      };
      setCanvasSize();
      window.addEventListener('resize', setCanvasSize);

      const ctx = canvas.getContext('2d');
      const dpr = window.devicePixelRatio || 1;
      ctx.scale(dpr, dpr);

      // Create audio context
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const analyser = audioContext.createAnalyser();
      analyser.fftSize = 2048;
      analyser.smoothingTimeConstant = 0.8;
      const bufferLength = analyser.frequencyBinCount;
      const frequencyData = new Uint8Array(bufferLength);
      const timeData = new Uint8Array(bufferLength);

      // Create source from audio element - this disconnects audio from default output
      // We need to reconnect it through the Web Audio API
      let source = null;
      try {
        source = audioContext.createMediaElementSource(audio);
        // Connect: source -> analyser -> destination
        // This ensures audio plays through speakers AND we can analyze it
        source.connect(analyser);
        analyser.connect(audioContext.destination);
      } catch (e) {
        console.error('Error creating media element source for', track.id, ':', e);
        // If source already exists (shouldn't happen, but handle it)
        if (e.name === 'InvalidStateError') {
          console.warn('MediaElementSource already exists, audio may not play correctly');
        }
      }

      let audioBuffer = null;
      let isPlaying = false;
      let animationFrameId = null;

      // Load and decode audio for static waveform
      // Use XMLHttpRequest instead of fetch to avoid CORS issues with file:// protocol
      const loadAudioBuffer = () => {
        const xhr = new XMLHttpRequest();
        xhr.open('GET', track.file, true);
        xhr.responseType = 'arraybuffer';
        
        xhr.onload = () => {
          if (xhr.status === 200 || xhr.status === 0) { // 0 for file:// protocol
            audioContext.decodeAudioData(xhr.response)
              .then(buffer => {
                audioBuffer = buffer;
                drawStaticWaveform();
              })
              .catch(err => {
                console.error('Error decoding audio for', track.id, ':', err);
                drawPlaceholder();
              });
          } else {
            console.error('Failed to load audio for', track.id, ':', xhr.status);
            drawPlaceholder();
          }
        };
        
        xhr.onerror = () => {
          console.warn('Could not load audio file for', track.id, '- waveform will still work for playback');
          // Don't show placeholder, just use a simple line
          drawSimpleWaveform();
        };
        
        try {
          xhr.send();
        } catch (err) {
          console.warn('CORS error loading audio for', track.id, '- using simple waveform');
          drawSimpleWaveform();
        }
      };
      
      loadAudioBuffer();

      // Draw static waveform from decoded audio buffer
      function drawStaticWaveform() {
        if (!audioBuffer) return;

        const width = canvas.offsetWidth;
        const height = 128;

        ctx.fillStyle = '#fff';
        ctx.fillRect(0, 0, width, height);

        const channelData = audioBuffer.getChannelData(0);
        const step = Math.ceil(channelData.length / width);
        const amp = height / 2;

        ctx.fillStyle = '#0078ff';
        ctx.beginPath();

        for (let i = 0; i < width; i++) {
          let min = 1.0;
          let max = -1.0;
          const start = i * step;
          const end = Math.min(start + step, channelData.length);
          
          for (let j = start; j < end; j++) {
            const datum = channelData[j];
            if (datum < min) min = datum;
            if (datum > max) max = datum;
          }
          
          const y = (1 + min) * amp;
          const barHeight = Math.max(1, (max - min) * amp);
          ctx.fillRect(i, y, 1, barHeight);
        }
      }

      // Draw placeholder
      function drawPlaceholder() {
        const width = canvas.offsetWidth;
        const height = 128;
        ctx.fillStyle = '#fff';
        ctx.fillRect(0, 0, width, height);
        ctx.fillStyle = '#ccc';
        ctx.font = '14px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('Loading...', width / 2, height / 2);
      }

      // Draw simple waveform (fallback when audio buffer can't be loaded)
      function drawSimpleWaveform() {
        const width = canvas.offsetWidth;
        const height = 128;
        ctx.fillStyle = '#fff';
        ctx.fillRect(0, 0, width, height);
        
        // Draw a simple horizontal line
        ctx.strokeStyle = '#0078ff';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(0, height / 2);
        ctx.lineTo(width, height / 2);
        ctx.stroke();
      }

      // Draw animated waveform when playing
      function drawAnimatedWaveform() {
        if (!isPlaying || audio.paused) {
          if (animationFrameId) {
            cancelAnimationFrame(animationFrameId);
            animationFrameId = null;
          }
          return;
        }

        analyser.getByteFrequencyData(frequencyData);

        const width = canvas.offsetWidth;
        const height = 128;

        ctx.fillStyle = '#fff';
        ctx.fillRect(0, 0, width, height);

        const barCount = Math.min(bufferLength, width / 2);
        const barWidth = width / barCount;
        let x = 0;

        for (let i = 0; i < barCount; i++) {
          const dataIndex = Math.floor((i / barCount) * bufferLength);
          const barHeight = (frequencyData[dataIndex] / 255) * height;
          
          const gradient = ctx.createLinearGradient(0, height - barHeight, 0, height);
          gradient.addColorStop(0, '#0078ff');
          gradient.addColorStop(1, '#0056b3');
          ctx.fillStyle = gradient;
          ctx.fillRect(x, height - barHeight, barWidth - 1, barHeight);
          x += barWidth;
        }

        // Draw progress overlay
        if (audio.duration && audio.duration > 0) {
          const progress = audio.currentTime / audio.duration;
          ctx.fillStyle = 'rgba(0, 120, 255, 0.2)';
          ctx.fillRect(0, 0, width * progress, height);
        }

        animationFrameId = requestAnimationFrame(drawAnimatedWaveform);
      }

      // Initial placeholder
      drawPlaceholder();

      // Play/Pause functionality
      playPauseBtn.addEventListener('click', async () => {
        try {
          // Resume audio context if suspended (browser autoplay policy)
          if (audioContext.state === 'suspended') {
            await audioContext.resume();
            console.log('Audio context resumed for', track.id);
          }

          if (audio.paused) {
            // Pause all other players first
            Object.keys(audioPlayers).forEach(id => {
              if (id !== track.id) {
                const otherPlayer = audioPlayers[id];
                if (otherPlayer && otherPlayer.audio && !otherPlayer.audio.paused) {
                  otherPlayer.audio.pause();
                  otherPlayer.isPlaying = false;
                  const otherBtn = document.getElementById(`play-pause-${id}`);
                  if (otherBtn) {
                    otherBtn.classList.remove('playing');
                  }
                  if (otherPlayer.animationFrameId) {
                    cancelAnimationFrame(otherPlayer.animationFrameId);
                    otherPlayer.animationFrameId = null;
                  }
                }
              }
            });

            // Ensure source is connected (in case it wasn't created properly)
            if (!source) {
              try {
                source = audioContext.createMediaElementSource(audio);
                source.connect(analyser);
                analyser.connect(audioContext.destination);
                console.log('Created MediaElementSource for', track.id);
              } catch (e) {
                console.error('Failed to create MediaElementSource:', e);
              }
            }

            await audio.play();
            isPlaying = true;
            playPauseBtn.classList.add('playing');
            drawAnimatedWaveform();
          } else {
            audio.pause();
            isPlaying = false;
            playPauseBtn.classList.remove('playing');
            if (animationFrameId) {
              cancelAnimationFrame(animationFrameId);
              animationFrameId = null;
            }
            drawStaticWaveform();
          }
        } catch (err) {
          console.error('Error playing audio for', track.id, ':', err);
          alert('Error playing audio: ' + err.message);
        }
      });

      // Click on canvas to seek
      canvas.addEventListener('click', (e) => {
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const percent = x / canvas.offsetWidth;
        if (audio.duration && audio.duration > 0) {
          audio.currentTime = percent * audio.duration;
        }
      });

      // Update time display
      audio.addEventListener('loadedmetadata', () => {
        const duration = audio.duration;
        if (duration && duration > 0) {
          const minutes = Math.floor(duration / 60);
          const seconds = Math.floor(duration % 60);
          timeDisplay.textContent = `0:00 / ${minutes}:${seconds.toString().padStart(2, '0')}`;
        }
      });

      audio.addEventListener('timeupdate', () => {
        const currentTime = audio.currentTime;
        const duration = audio.duration;
        if (duration && duration > 0) {
          const currentMinutes = Math.floor(currentTime / 60);
          const currentSeconds = Math.floor(currentTime % 60);
          const durationMinutes = Math.floor(duration / 60);
          const durationSeconds = Math.floor(duration % 60);
          timeDisplay.textContent = `${currentMinutes}:${currentSeconds.toString().padStart(2, '0')} / ${durationMinutes}:${durationSeconds.toString().padStart(2, '0')}`;
        }
      });

      audio.addEventListener('ended', () => {
        isPlaying = false;
        playPauseBtn.classList.remove('playing');
        if (animationFrameId) {
          cancelAnimationFrame(animationFrameId);
          animationFrameId = null;
        }
        drawStaticWaveform();
      });

      audio.addEventListener('error', (e) => {
        console.error('Audio error for', track.id, ':', e);
        playPauseBtn.disabled = true;
        playPauseBtn.textContent = 'Error';
      });

      // Store player data
      audioPlayers[track.id] = { 
        audio, 
        audioContext, 
        analyser, 
        isPlaying, 
        animationFrameId,
        drawAnimatedWaveform,
        drawStaticWaveform
      };
    });
  </script>

</body>
</html>

